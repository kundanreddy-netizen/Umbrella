<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Umbrella</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        h1 { color: #667eea; margin-bottom: 30px; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .form-container { display: none; background: #f0f0f0; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .form-container.show { display: block; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Admin Dashboard</h1>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('approvals')">Pending Approvals</button>
            <button class="tab-btn" onclick="switchTab('services')">Service Contacts</button>
        </div>

        <div id="approvalsTab" class="tab-content active">
            <h2>Pending User Approvals</h2>
            <div id="pendingList"><div class="empty-state">Loading...</div></div>
        </div>

        <div id="servicesTab" class="tab-content">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>Service Contacts</h2>
                <button class="btn btn-success" onclick="toggleServiceForm()">‚ûï Add Service Contact</button>
            </div>

            <div id="serviceForm" class="form-container">
                <h3 style="margin-bottom: 15px;">Add New Service Contact</h3>
                <div class="input-group">
                    <label>Service Name *</label>
                    <input type="text" id="serviceName" placeholder="ABC Plumbing">
                </div>
                <div class="input-group">
                    <label>Category *</label>
                    <select id="serviceCategory">
                        <option value="plumber">üîß Plumber</option>
                        <option value="electrician">‚ö° Electrician</option>
                        <option value="landscaping">üå≥ Landscaping</option>
                        <option value="pest_control">üêõ Pest Control</option>
                        <option value="security">üîí Security</option>
                        <option value="cleaning">üßπ Cleaning</option>
                        <option value="hvac">‚ùÑÔ∏è HVAC</option>
                        <option value="general">üõ†Ô∏è General</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Phone *</label>
                    <input type="tel" id="servicePhone" placeholder="555-1234">
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="serviceEmail" placeholder="contact@service.com">
                </div>
                <div class="input-group">
                    <label>Notes</label>
                    <textarea id="serviceNotes" rows="3" placeholder="Additional info..."></textarea>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="addServiceContact()">Save</button>
                    <button class="btn" style="background: #ccc;" onclick="toggleServiceForm()">Cancel</button>
                </div>
            </div>

            <div id="servicesList"><div class="empty-state">Loading...</div></div>
        </div>
    </div>

    <script>
        firebase.initializeApp({
            apiKey: "AIzaSyDY_2X7mk9eCM24sVj0glrJhG7n2PSAff8",
            authDomain: "umbrella-6b57a.firebaseapp.com",
            projectId: "umbrella-6b57a",
            storageBucket: "umbrella-6b57a.firebasestorage.app",
            messagingSenderId: "636033970250",
            appId: "1:636033970250:web:a49918b1f0d6e46cdcb6b3"
        });

        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser, userCommunityId;

        auth.onAuthStateChanged(async (user) => {
            if (!user) { alert('Login first'); window.close(); return; }
            currentUser = user;
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'admin') {
                alert('Admin only'); window.close(); return;
            }
            userCommunityId = userDoc.data().communityId;
            loadPendingApprovals();
            loadServiceContacts();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        async function loadPendingApprovals() {
            const container = document.getElementById('pendingList');
            try {
                const snapshot = await db.collection('residents')
                    .where('communityId', '==', userCommunityId)
                    .where('isApproved', '==', false).get();
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state">No pending approvals</div>';
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="card"><h3>${d.name}</h3><p>Email: ${d.email}</p><p>Phone: ${d.phone}</p><p>Unit: ${d.unitNumber}</p>
                    <div style="margin-top:15px;display:flex;gap:10px;">
                    <button class="btn btn-success" onclick="approveUser('${doc.id}','${d.userId}')">‚úÖ Approve</button>
                    <button class="btn btn-danger" onclick="rejectUser('${doc.id}','${d.userId}')">‚ùå Reject</button>
                    </div></div>`;
                });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<div class="empty-state">Error</div>'; }
        }

        async function approveUser(residentId, userId) {
            if (!confirm('Approve?')) return;
            try {
                await db.collection('residents').doc(residentId).update({ isApproved: true, approvedAt: firebase.firestore.FieldValue.serverTimestamp() });
                await db.collection('users').doc(userId).update({ isApproved: true });
                alert('‚úÖ Approved!');
                loadPendingApprovals();
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function rejectUser(residentId, userId) {
            if (!confirm('Reject and delete?')) return;
            try {
                await db.collection('residents').doc(residentId).delete();
                await db.collection('users').doc(userId).delete();
                alert('‚ùå Rejected');
                loadPendingApprovals();
            } catch(e) { alert('Error: ' + e.message); }
        }

        function toggleServiceForm() {
            document.getElementById('serviceForm').classList.toggle('show');
        }

        async function addServiceContact() {
            const name = document.getElementById('serviceName').value.trim();
            const phone = document.getElementById('servicePhone').value.trim();
            if (!name || !phone) { alert('Enter name and phone'); return; }
            try {
                await db.collection('service_contacts').add({
                    communityId: userCommunityId,
                    name: name,
                    category: document.getElementById('serviceCategory').value,
                    phone: phone,
                    email: document.getElementById('serviceEmail').value.trim(),
                    notes: document.getElementById('serviceNotes').value.trim(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
                alert('‚úÖ Added!');
                toggleServiceForm();
                loadServiceContacts();
            } catch(e) { alert('Error: ' + e.message); }
        }

        async function loadServiceContacts() {
            const container = document.getElementById('servicesList');
            try {
                const snapshot = await db.collection('service_contacts').where('communityId', '==', userCommunityId).get();
                if (snapshot.empty) {
                    container.innerHTML = '<div class="empty-state">No contacts</div>';
                    return;
                }
                const icons = { plumber:'üîß', electrician:'‚ö°', landscaping:'üå≥', pest_control:'üêõ', security:'üîí', cleaning:'üßπ', hvac:'‚ùÑÔ∏è', general:'üõ†Ô∏è' };
                let html = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    html += `<div class="card"><div style="display:flex;justify-content:space-between;">
                    <div><h3>${icons[d.category]||'üõ†Ô∏è'} ${d.name}</h3><p style="color:#666;">${(d.category||'').replace('_',' ').toUpperCase()}</p>
                    <p>üìû ${d.phone}</p>${d.email?`<p>üìß ${d.email}</p>`:''}${d.notes?`<p style="color:#666;">${d.notes}</p>`:''}</div>
                    <button class="btn btn-danger" onclick="deleteService('${doc.id}')">üóëÔ∏è</button></div></div>`;
                });
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<div class="empty-state">Error</div>'; }
        }

        async function deleteService(id) {
            if (!confirm('Delete?')) return;
            await db.collection('service_contacts').doc(id).delete();
            alert('‚úÖ Deleted');
            loadServiceContacts();
        }
    </script>
</body>
</html>
