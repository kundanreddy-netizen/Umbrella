<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Umbrella</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header {
            background: white;
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
        }

        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 14px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stat-icon { font-size: 32px; }
        
        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-subtitle {
            font-size: 13px;
            color: #999;
        }

        .expand-hint {
            position: absolute;
            bottom: 12px;
            right: 15px;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        /* Expandable Sections */
        .expandable {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }

        .expandable.active { display: block; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-danger { background: #ff4757; color: white; }
        .btn-secondary { background: #f0f0f0; color: #666; }
        .btn-small { padding: 6px 12px; font-size: 13px; }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        input[type="text"], select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="text"] { flex: 1; min-width: 250px; }
        select { min-width: 150px; }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover { background: #f8f9fa; }

        /* Announcements */
        .announcements-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .announcement-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .announcement-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .announcement-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #999;
            margin-top: 10px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Loading */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>
            <div class="spinner"></div>
            <div>Loading Dashboard...</div>
        </div>
    </div>

    <div class="container" id="dashboard" style="display:none;">
        <div class="header">
            <div>
                <div class="header-title">üèòÔ∏è Admin Dashboard</div>
                <div style="font-size:14px; color:#666; margin-top:5px;" id="community">Covington HOA</div>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <!-- Stats (Clickable) -->
        <div class="stats-grid">
            <div class="stat-card" onclick="toggle('residents')">
                <div class="stat-header">
                    <div class="stat-title">Total Residents</div>
                    <div class="stat-icon">üë•</div>
                </div>
                <div class="stat-value" id="totalResidents">0</div>
                <div class="stat-subtitle">Active residents</div>
                <div class="expand-hint">Click to expand ‚Üí</div>
            </div>

            <div class="stat-card" onclick="toggle('pending')">
                <div class="stat-header">
                    <div class="stat-title">Pending Approvals</div>
                    <div class="stat-icon">‚è≥</div>
                </div>
                <div class="stat-value" id="pendingCount">0</div>
                <div class="stat-subtitle">Awaiting approval</div>
                <div class="expand-hint">Click to expand ‚Üí</div>
            </div>

            <div class="stat-card" onclick="toggle('tickets')">
                <div class="stat-header">
                    <div class="stat-title">Open Tickets</div>
                    <div class="stat-icon">üîß</div>
                </div>
                <div class="stat-value" id="openTickets">0</div>
                <div class="stat-subtitle">Need attention</div>
                <div class="expand-hint">Click to expand ‚Üí</div>
            </div>

            <div class="stat-card" onclick="toggle('visitors')">
                <div class="stat-header">
                    <div class="stat-title">Active Visitors</div>
                    <div class="stat-icon">üöó</div>
                </div>
                <div class="stat-value" id="activeVisitors">0</div>
                <div class="stat-subtitle">Today</div>
                <div class="expand-hint">Click to expand ‚Üí</div>
            </div>
        </div>

        <!-- Expandable: Residents -->
        <div id="residentsSection" class="expandable">
            <div class="section-header">
                <h2 class="section-title">üë• All Residents</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="exportResidents()">üìä Export Excel</button>
                    <button class="btn btn-secondary" onclick="toggle('residents')">Close ‚úï</button>
                </div>
            </div>
            <div class="filters">
                <input type="text" id="residentSearch" placeholder="üîç Search name, unit, email, phone..." oninput="filterResidents()">
            </div>
            <div id="residentsTable"></div>
        </div>

        <!-- Expandable: Pending -->
        <div id="pendingSection" class="expandable">
            <div class="section-header">
                <h2 class="section-title">‚è≥ Pending Approvals</h2>
                <button class="btn btn-secondary" onclick="toggle('pending')">Close ‚úï</button>
            </div>
            <div id="pendingTable"></div>
        </div>

        <!-- Expandable: Tickets -->
        <div id="ticketsSection" class="expandable">
            <div class="section-header">
                <h2 class="section-title">üîß Support Tickets</h2>
                <button class="btn btn-secondary" onclick="toggle('tickets')">Close ‚úï</button>
            </div>
            <div class="filters">
                <input type="text" id="ticketSearch" placeholder="üîç Search..." oninput="filterTickets()">
                <select id="statusFilter" onchange="filterTickets()">
                    <option value="">All Status</option>
                    <option value="open">Open</option>
                    <option value="in-progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            <div id="ticketsTable"></div>
        </div>

        <!-- Expandable: Visitors -->
        <div id="visitorsSection" class="expandable">
            <div class="section-header">
                <h2 class="section-title">üöó Today's Visitors</h2>
                <button class="btn btn-secondary" onclick="toggle('visitors')">Close ‚úï</button>
            </div>
            <div id="visitorsTable"></div>
        </div>

        <!-- Announcements (Always Visible) -->
        <div class="announcements-section">
            <div class="section-header">
                <h2 class="section-title">üì¢ Recent Announcements</h2>
                <button class="btn btn-primary" onclick="showModal()">+ Create Announcement</button>
            </div>
            <div id="announcements"></div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom:20px;">Create Announcement</h2>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="title" style="width:100%;">
            </div>
            <div class="form-group">
                <label>Message</label>
                <textarea id="message"></textarea>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="category" style="width:100%;">
                    <option>general</option>
                    <option>maintenance</option>
                    <option>event</option>
                    <option>alert</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="createAnnouncement()">Create</button>
                <button class="btn btn-secondary" style="flex:1;" onclick="hideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDY_2X7mk9eCM24sVj0glrJhG7n2PSAff8",
            authDomain: "umbrella-6b57a.firebaseapp.com",
            projectId: "umbrella-6b57a",
            storageBucket: "umbrella-6b57a.firebasestorage.app",
            messagingSenderId: "636033970250",
            appId: "1:636033970250:web:a49918b1f0d6e46cdcb6b3"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let user, communityId;
        let allResidents = [];
        let allTickets = [];

        auth.onAuthStateChanged(async (u) => {
            if (!u) { window.location.href = 'index.html'; return; }
            
            user = u;
            const doc = await db.collection('users').doc(u.uid).get();
            const data = doc.data();
            
            if (!data.role || (data.role !== 'admin' && data.role !== 'super-admin')) {
                alert('Admin access required');
                await auth.signOut();
                window.location.href = 'index.html';
                return;
            }

            communityId = data.communityId;
            if (!communityId) {
                alert('Missing communityId');
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadAll();
        });

        async function loadAll() {
            loadStats();
            loadAnnouncements();
            loadResidents();
            loadPending();
            loadTickets();
            loadVisitors();
        }

        async function loadStats() {
            const residents = await db.collection('residents').where('communityId', '==', communityId).get();
            document.getElementById('totalResidents').textContent = residents.size;

            const pending = await db.collection('users').where('communityId', '==', communityId).where('isApproved', '==', false).get();
            document.getElementById('pendingCount').textContent = pending.size;

            const tickets = await db.collection('tickets').where('communityId', '==', communityId).where('status', 'in', ['open', 'in-progress']).get();
            document.getElementById('openTickets').textContent = tickets.size;

            const today = new Date();
            today.setHours(0,0,0,0);
            const visitors = await db.collection('visitors').where('communityId', '==', communityId).where('visitDate', '>=', firebase.firestore.Timestamp.fromDate(today)).get();
            document.getElementById('activeVisitors').textContent = visitors.size;
        }

        function toggle(section) {
            ['residents', 'pending', 'tickets', 'visitors'].forEach(s => {
                const el = document.getElementById(s + 'Section');
                if (s === section) {
                    el.classList.toggle('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }

        async function loadResidents() {
            const snap = await db.collection('residents').where('communityId', '==', communityId).get();
            allResidents = [];
            snap.forEach(doc => allResidents.push({id: doc.id, ...doc.data()}));
            displayResidents(allResidents);
        }

        function displayResidents(list) {
            const el = document.getElementById('residentsTable');
            if (list.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div>No residents</div></div>';
                return;
            }

            let html = '<table><tr><th>Name</th><th>Unit</th><th>Email</th><th>Phone</th></tr>';
            list.forEach(r => {
                html += `<tr><td><strong>${r.name || 'N/A'}</strong></td><td>${r.unitNumber || 'N/A'}</td><td>${r.email || 'N/A'}</td><td>${r.phone || 'N/A'}</td></tr>`;
            });
            html += '</table>';
            el.innerHTML = html;
        }

        function filterResidents() {
            const search = document.getElementById('residentSearch').value.toLowerCase();
            const filtered = allResidents.filter(r => 
                (r.name || '').toLowerCase().includes(search) ||
                (r.email || '').toLowerCase().includes(search) ||
                (r.phone || '').toLowerCase().includes(search) ||
                (r.unitNumber || '').toLowerCase().includes(search)
            );
            displayResidents(filtered);
        }

        async function loadPending() {
            const snap = await db.collection('users').where('communityId', '==', communityId).where('isApproved', '==', false).get();
            const el = document.getElementById('pendingTable');
            
            if (snap.empty) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><div>No pending approvals</div></div>';
                return;
            }

            let html = '<table><tr><th>Name</th><th>Email</th><th>Unit</th><th>Actions</th></tr>';
            snap.forEach(doc => {
                const d = doc.data();
                html += `<tr><td><strong>${d.name}</strong></td><td>${d.email}</td><td>${d.unitNumber || 'N/A'}</td><td><button class="btn btn-success btn-small" onclick="approve('${doc.id}')">‚úì Approve</button> <button class="btn btn-danger btn-small" onclick="reject('${doc.id}')">‚úï Reject</button></td></tr>`;
            });
            html += '</table>';
            el.innerHTML = html;
        }

        async function approve(id) {
            if (!confirm('Approve this resident?')) return;
            await db.collection('users').doc(id).update({isApproved: true});
            alert('‚úÖ Approved!');
            loadPending();
            loadStats();
        }

        async function reject(id) {
            if (!confirm('Reject this application?')) return;
            await db.collection('users').doc(id).delete();
            alert('Rejected');
            loadPending();
            loadStats();
        }

        async function loadTickets() {
            const snap = await db.collection('tickets').where('communityId', '==', communityId).get();
            allTickets = [];
            snap.forEach(doc => allTickets.push({id: doc.id, ...doc.data()}));
            displayTickets(allTickets);
        }

        function displayTickets(list) {
            const el = document.getElementById('ticketsTable');
            if (list.length === 0) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">üîß</div><div>No tickets</div></div>';
                return;
            }

            let html = '<table><tr><th>Title</th><th>Resident</th><th>Status</th><th>Priority</th><th>Created</th></tr>';
            list.forEach(t => {
                const date = t.createdAt ? t.createdAt.toDate().toLocaleDateString() : 'N/A';
                html += `<tr><td><strong>${t.title}</strong></td><td>${t.residentName || 'N/A'}</td><td><span style="background:${t.status === 'open' ? '#ff4757' : '#4CAF50'}; color:white; padding:4px 8px; border-radius:4px; font-size:12px;">${t.status || 'open'}</span></td><td>${t.priority || 'medium'}</td><td>${date}</td></tr>`;
            });
            html += '</table>';
            el.innerHTML = html;
        }

        function filterTickets() {
            const search = document.getElementById('ticketSearch').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            
            const filtered = allTickets.filter(t => {
                const matchSearch = (t.title || '').toLowerCase().includes(search) || (t.residentName || '').toLowerCase().includes(search);
                const matchStatus = !status || t.status === status;
                return matchSearch && matchStatus;
            });
            displayTickets(filtered);
        }

        async function loadVisitors() {
            const today = new Date();
            today.setHours(0,0,0,0);
            const snap = await db.collection('visitors').where('communityId', '==', communityId).where('visitDate', '>=', firebase.firestore.Timestamp.fromDate(today)).get();
            
            const el = document.getElementById('visitorsTable');
            if (snap.empty) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">üöó</div><div>No visitors today</div></div>';
                return;
            }

            let html = '<table><tr><th>Visitor</th><th>Host</th><th>Vehicle</th><th>Time</th><th>Status</th></tr>';
            snap.forEach(doc => {
                const d = doc.data();
                const time = d.visitDate ? d.visitDate.toDate().toLocaleTimeString() : 'N/A';
                html += `<tr><td><strong>${d.visitorName}</strong></td><td>${d.residentName || 'N/A'}</td><td>${d.vehicleNumber || 'N/A'}</td><td>${time}</td><td><span style="background:${d.status === 'approved' ? '#4CAF50' : '#ff4757'}; color:white; padding:4px 8px; border-radius:4px; font-size:12px;">${d.status}</span></td></tr>`;
            });
            html += '</table>';
            el.innerHTML = html;
        }

        async function loadAnnouncements() {
            const snap = await db.collection('announcements').where('communityId', '==', communityId).orderBy('createdAt', 'desc').limit(5).get();
            const el = document.getElementById('announcements');
            
            if (snap.empty) {
                el.innerHTML = '<div class="empty-state"><div class="empty-icon">üì¢</div><div>No announcements</div></div>';
                return;
            }

            let html = '';
            snap.forEach(doc => {
                const d = doc.data();
                const date = d.createdAt ? d.createdAt.toDate().toLocaleDateString() : 'N/A';
                html += `<div class="announcement-card"><div class="announcement-title">${d.title}</div><div>${d.message}</div><div class="announcement-meta"><span>üìÅ ${d.category}</span><span>üìÖ ${date}</span><span>üë§ ${d.author}</span></div></div>`;
            });
            el.innerHTML = html;
        }

        function showModal() {
            document.getElementById('modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
            document.getElementById('title').value = '';
            document.getElementById('message').value = '';
        }

        async function createAnnouncement() {
            const title = document.getElementById('title').value.trim();
            const message = document.getElementById('message').value.trim();
            const category = document.getElementById('category').value;

            if (!title || !message) {
                alert('Please fill all fields');
                return;
            }

            const userData = await db.collection('users').doc(user.uid).get();
            const name = userData.data().name || 'Admin';

            await db.collection('announcements').add({
                title,
                message,
                category,
                author: name,
                authorId: user.uid,
                communityId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                readBy: []
            });

            hideModal();
            alert('‚úÖ Announcement created!');
            loadAnnouncements();
        }

        function exportResidents() {
            if (allResidents.length === 0) {
                alert('No residents to export');
                return;
            }

            let csv = 'Name,Unit,Email,Phone\n';
            allResidents.forEach(r => {
                csv += `"${r.name || ''}","${r.unitNumber || ''}","${r.email || ''}","${r.phone || ''}"\n`;
            });

            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'residents.csv';
            a.click();
        }

        function logout() {
            if (confirm('Logout?')) {
                auth.signOut().then(() => window.location.href = 'index.html');
            }
        }
    </script>
</body>
</html>
