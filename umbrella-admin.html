<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umbrella - Admin Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
        }

        h1 {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
        }

        .admin-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
            margin-top: 10px;
        }

        .section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f5f5ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #f5f5ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 16px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .upload-subtext {
            font-size: 13px;
            color: #999;
        }

        .file-input {
            display: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            line-height: 1.4;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: #dc3545;
        }

        .status-box {
            background: white;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-box h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #666;
        }

        .status-value {
            font-weight: 600;
            color: #333;
        }

        .success-message {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.3s;
        }

        .error-message {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .setup-needed {
            background: #e8f4f8;
            border-left: 4px solid #17a2b8;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .setup-needed h3 {
            color: #17a2b8;
            margin-bottom: 15px;
        }

        .setup-needed ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .setup-needed code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .config-status.ready {
            background: #d4edda;
            color: #155724;
        }

        .config-status.not-ready {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 20 C30 20, 15 30, 15 45 L15 50 C15 50, 20 60, 50 60 C80 60, 85 50, 85 50 L85 45 C85 30, 70 20, 50 20 Z" fill="#667eea"/>
                <rect x="48" y="55" width="4" height="35" fill="#764ba2" rx="2"/>
                <path d="M48 85 C48 85, 42 95, 35 95" stroke="#764ba2" stroke-width="3" fill="none" stroke-linecap="round"/>
            </svg>
            <h1>Umbrella</h1>
            <p class="subtitle">Admin Panel - Data Management</p>
            <span class="admin-badge">üëë Admin Access</span>
        </div>

        <div id="configStatus"></div>
        <div id="messages"></div>

        <div class="section" id="setupSection">
            <div class="section-title">
                <span>‚öôÔ∏è</span>
                <span>GitHub Configuration</span>
            </div>

            <div class="setup-needed">
                <h3>üîë One-Time Setup Required</h3>
                <p style="margin-bottom: 15px;">To enable data syncing, you need to create a GitHub Personal Access Token:</p>
                <ol>
                    <li>Go to <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Tokens</a></li>
                    <li>Click "Generate new token" ‚Üí "Generate new token (classic)"</li>
                    <li>Name: <code>Umbrella App</code></li>
                    <li>Check the <code>repo</code> scope (full control)</li>
                    <li>Click "Generate token" at the bottom</li>
                    <li>Copy the token and paste it below</li>
                </ol>
            </div>

            <div class="input-group">
                <label>GitHub Username</label>
                <input type="text" id="githubUsername" placeholder="kundanreddy-netizen" value="kundanreddy-netizen">
            </div>

            <div class="input-group">
                <label>Repository Name</label>
                <input type="text" id="repoName" placeholder="Umbrella" value="Umbrella">
            </div>

            <div class="input-group">
                <label>GitHub Personal Access Token</label>
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <div class="help-text">
                    This token is stored locally in your browser and never shared
                </div>
            </div>

            <button class="btn" onclick="saveConfig()">üíæ Save Configuration</button>
        </div>

        <div class="section" id="uploadSection" style="display: none;">
            <div class="section-title">
                <span>üìä</span>
                <span>Upload Excel Data</span>
            </div>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Upload Umbrella.xlsx</div>
                <div class="upload-subtext">Click or drag and drop your Excel file here</div>
            </div>

            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">

            <button class="btn" id="uploadBtn" onclick="uploadToGitHub()" style="display: none;">
                üì§ Publish Data to All Apps
            </button>

            <div class="info-box">
                üí° <strong>How it works:</strong><br>
                1. Upload your Excel file here<br>
                2. Click "Publish Data to All Apps"<br>
                3. Data is saved to your GitHub repository<br>
                4. All mobile apps will automatically sync and show the new data!
            </div>
        </div>

        <div class="section" id="statusSection" style="display: none;">
            <div class="section-title">
                <span>üì±</span>
                <span>Current Data Status</span>
            </div>

            <div class="status-box" id="statusBox">
                <h3>Published Data</h3>
                <div class="status-item">
                    <span class="status-label">Residents:</span>
                    <span class="status-value" id="residentCount">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Announcements:</span>
                    <span class="status-value" id="announcementCount">-</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Updated:</span>
                    <span class="status-value" id="lastUpdated">Never</span>
                </div>
            </div>

            <button class="btn" onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button class="btn" onclick="showSetup()">‚öôÔ∏è Update Configuration</button>
        </div>
    </div>

    <script>
        let pendingData = null;
        let config = null;

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
        });

        // Drag and drop handlers
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function loadConfig() {
            const saved = localStorage.getItem('umbrellaGitHubConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('githubUsername').value = config.username;
                document.getElementById('repoName').value = config.repo;
                document.getElementById('githubToken').value = config.token;
                
                showUploadSection();
                refreshStatus();
            } else {
                showSetup();
            }
        }

        function saveConfig() {
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('repoName').value.trim();
            const token = document.getElementById('githubToken').value.trim();

            if (!username || !repo || !token) {
                showMessage('‚ùå Please fill in all fields', 'error');
                return;
            }

            config = { username, repo, token };
            localStorage.setItem('umbrellaGitHubConfig', JSON.stringify(config));

            showMessage('‚úÖ Configuration saved successfully!', 'success');
            showUploadSection();
            refreshStatus();
        }

        function showSetup() {
            document.getElementById('setupSection').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('statusSection').style.display = 'none';
        }

        function showUploadSection() {
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('statusSection').style.display = 'block';
            
            const statusDiv = document.getElementById('configStatus');
            statusDiv.innerHTML = '<div class="config-status ready">‚úÖ GitHub configured and ready</div>';
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showMessage('‚ùå Please upload an Excel file (.xlsx or .xls)', 'error');
                return;
            }

            showMessage('Reading Excel file...', 'loading');

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const sheetNames = workbook.SheetNames;

                    // First sheet = Residents
                    let owners = [];
                    if (sheetNames.length > 0) {
                        const firstSheet = workbook.Sheets[sheetNames[0]];
                        owners = XLSX.utils.sheet_to_json(firstSheet);
                    }

                    // Second sheet = Announcements
                    let announcements = [];
                    if (sheetNames.length > 1) {
                        const secondSheet = workbook.Sheets[sheetNames[1]];
                        announcements = XLSX.utils.sheet_to_json(secondSheet);
                    }

                    pendingData = {
                        owners: owners,
                        announcements: announcements,
                        lastUpdated: new Date().toISOString()
                    };

                    showMessage(`‚úÖ File loaded successfully! <br>Residents: ${owners.length} | Announcements: ${announcements.length}`, 'success');
                    document.getElementById('uploadBtn').style.display = 'block';

                } catch (error) {
                    showMessage('‚ùå Error reading Excel file: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function uploadToGitHub() {
            if (!pendingData) {
                showMessage('‚ùå Please upload a file first', 'error');
                return;
            }

            if (!config) {
                showMessage('‚ùå Please configure GitHub settings first', 'error');
                showSetup();
                return;
            }

            showMessage('Publishing data to GitHub...', 'loading');

            try {
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(pendingData, null, 2))));
                
                // Check if file exists
                let sha = null;
                try {
                    const checkResponse = await fetch(
                        `https://api.github.com/repos/${config.username}/${config.repo}/contents/umbrella-data.json`,
                        {
                            headers: {
                                'Authorization': `token ${config.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    if (checkResponse.ok) {
                        const fileData = await checkResponse.json();
                        sha = fileData.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's fine
                }

                // Create or update file
                const body = {
                    message: 'Update Umbrella data',
                    content: content,
                    branch: 'main'
                };
                
                if (sha) {
                    body.sha = sha;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents/umbrella-data.json`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    }
                );

                if (response.ok) {
                    showMessage('‚úÖ Data published successfully! All mobile apps will sync within 30 seconds.', 'success');
                    refreshStatus();
                    document.getElementById('uploadBtn').style.display = 'none';
                    pendingData = null;
                    document.getElementById('fileInput').value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to publish data');
                }

            } catch (error) {
                showMessage('‚ùå Error publishing data: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function refreshStatus() {
            if (!config) return;

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${config.username}/${config.repo}/contents/umbrella-data.json`,
                    {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.ok) {
                    const fileData = await response.json();
                    const content = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));
                    
                    document.getElementById('residentCount').textContent = content.owners?.length || 0;
                    document.getElementById('announcementCount').textContent = content.announcements?.length || 0;
                    
                    if (content.lastUpdated) {
                        const date = new Date(content.lastUpdated);
                        document.getElementById('lastUpdated').textContent = date.toLocaleString();
                    }
                } else {
                    document.getElementById('residentCount').textContent = '0';
                    document.getElementById('announcementCount').textContent = '0';
                    document.getElementById('lastUpdated').textContent = 'No data published yet';
                }
            } catch (error) {
                console.log('No data found:', error);
                document.getElementById('residentCount').textContent = '0';
                document.getElementById('announcementCount').textContent = '0';
                document.getElementById('lastUpdated').textContent = 'No data published yet';
            }
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            
            let className = 'success-message';
            if (type === 'error') className = 'error-message';
            if (type === 'loading') {
                messagesDiv.innerHTML = `
                    <div class="success-message">
                        <div class="spinner"></div>
                        ${message}
                    </div>
                `;
                return;
            }
            
            messagesDiv.innerHTML = `<div class="${className}">${message}</div>`;
            
            // Auto-hide after 5 seconds for success/error messages
            if (type !== 'loading') {
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>
